# API Contracts for SmartSales

This document captures the detailed API contracts shared between the Android app, companion devices, and cloud services. It complements `frontend_inte_plan.md` by drilling into HTTP endpoints, payload structures, BLE command formats, and error models. Update this file whenever schemas change or new services are introduced.

## AI Chat & Completion APIs
- **Service**: Alibaba DashScope text generation (`https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation`).
- **Request model** (`DashscopeRequest`):
  - `apiKey` – provided by `DashscopeCredentialsProvider`.
  - `model` – e.g. `qwen-plus`.
  - `messages[]` – ordered list of `{ role: "system"|"user", content: String }`. System prompt built from skill tags; user prompt concatenates raw question, optional Tingwu transcript, and attachment manifest.
  - `temperature` default `0.3`.
- **Response**: `DashscopeCompletion { displayText }` which becomes `AiChatResponse { displayText, structuredMarkdown, references[] }`. Markdown includes summary metadata (prompt, skills, attachment count, optional transcript excerpt).
- **Streaming**: `DashscopeStreamEvent` surfaces `Chunk(content)`, `Completed`, `Failed`. The accumulator builds the final `AiChatResponse` when completed.
- **Error contract**: map to `AiCoreException` with `source=DASH_SCOPE` and reasons `MISSING_CREDENTIALS|NETWORK|TIMEOUT|REMOTE|UNKNOWN`. Retries follow `AiCoreConfig.dashscopeMaxRetries`; timeout controlled by `dashscopeRequestTimeoutMillis`.
- **Positive example**: valid credentials + prompt produce `DashscopeCompletion.displayText="您好，以下是建议..."`, yielding Markdown with “## 输入摘要”.
- **Negative example**: blank `apiKey` triggers `AiCoreException(source=DASH_SCOPE, reason=MISSING_CREDENTIALS)` and short-circuits before calling the SDK.

## Transcription (Tingwu) APIs
- **Service root**: `https://<region>.aliyuncs.com/openapi/tingwu/v2/` (configurable via `AiCoreConfig.tingwuBaseUrlOverride`).
- **Headers/Auth**: ROA signature generated by `TingwuAuthInterceptor`, plus `x-tingwu-app-key`, canonical `x-acs-date`, `Authorization: acs <AccessKeyId>:<Signature>`.
- **Endpoints**:
  1. `PUT /tasks?type=offline` with body `TingwuCreateTaskRequest { appKey, input: { sourceLanguage, taskKey, fileUrl }, parameters: { transcription: { diarizationEnabled, model }}}`.
  2. `GET /tasks/{taskId}?type=offline` returning `TingwuStatusResponse { code, message, data: TingwuStatusData{ taskStatus, progress, errorCode, taskId }}`.
  3. `GET /tasks/{taskId}/transcription?format=json` returning `TingwuResultResponse { data: TingwuResultData{ transcription: TingwuTranscription, artifacts[] }}`.
- **Lifecycle**: `RealTingwuCoordinator.submit()` resolves OSS URLs, issues CreateTask, tracks job via `TingwuJobState`. Poll intervals/timeouts sourced from `AiCoreConfig`.
- **Errors**: map HTTP/network issues to `AiCoreException` with `source=TINGWU` and reasons `MISSING_CREDENTIALS|TIMEOUT|REMOTE|NETWORK`. JSON responses lacking `taskId` or transcription body trigger `AiCoreException` with actionable suggestions.
- **Positive example**: `PUT /tasks?type=offline` → `{ code:200, data:{ taskId:"tw-001", taskStatus:"SUBMITTED" } }`, so UI shows “转写中 10%”.
- **Negative example**: `GET /tasks/{id}` returning `{ code:500, message:"signature invalid" }` maps to `AiCoreException(reason=REMOTE)` suggesting re-check of ROA signing.

## Device Connectivity & Control APIs
- **BLE command channel** (GattBleGateway):
  - Credentials payload: `wifi#connect#<ssid>#<password>` (segments sanitized to strip `#`). Device returns either JSON (`{ handshake_id, credentials_hash, rejected }`) or delimited string (`wifi#connect#ok|error#<handshakeId|reason>`).
  - Hotspot query: read `hotspotCharacteristic` returning JSON `{ "ssid": "...", "password": "..." }`.
  - Network query command: write literal `wifi#address#ip#name`, expect JSON `{ ip, device_wifi, phone_wifi }` or delimited `wifi#address#<ip>#<deviceWifi>#<phoneWifi>`.
- **Result mapping**:
  - Success → `ProvisioningStatus { wifiSsid, handshakeId, credentialsHash }`.
  - Failures converted to `ProvisioningException.PermissionDenied|Timeout|Transport|CredentialRejected`, which bubble up as `ConnectivityError` in `ConnectionState.Error`.
- **HTTP device gateway** (Media server control lives here but called from connectivity flows):
  - Base URL discovered via BLE/network query; used for Wi-Fi/HTTP diagnostics inside the tester page.
- **Positive example**: device replies `wifi#connect#ok#handshake123`, so Android moves to `ConnectionState.WifiProvisioned` with that handshake ID.
- **Negative example**: device replies `wifi#connect#error#auth_failed`, producing `ProvisioningException.CredentialRejected("auth_failed")` and an error banner in UI.

## Media & OSS Storage APIs
- **Gadget media server** (`MediaServerClient`):
  - `GET /files` → `{ "files": [ { name, sizeBytes, mimeType, modifiedAtMillis, mediaUrl, downloadUrl } ] }`.
  - `POST /upload` – multipart form field `file` with original filename and MIME type; server responds 2xx on success.
  - `POST /apply/{filename}` – instructs device to use file.
  - `DELETE /delete/{filename}` – removes asset.
  - `GET downloadUrl` – raw bytes stream used for local caching.
  - Timeouts: 10–15 s depending on verb; errors thrown as `IllegalStateException` and wrapped in `Result.Error`.
- **Aliyun OSS** (`RealOssUploadClient`):
  - Upload via SDK `PutObjectRequest(bucket, objectKey, localPath)`; default key prefix `ai-test/<timestamp>-<filename>`.
  - Presigned download URL valid `900s` generated with `presignConstrainedObjectURL`.
  - Credential fields: `OSS_ACCESS_KEY_ID`, `OSS_ACCESS_KEY_SECRET`, `OSS_BUCKET_NAME`, `OSS_ENDPOINT`.
  - Error wrapper: `AiCoreException` with reasons `MISSING_CREDENTIALS|IO|NETWORK|REMOTE|UNKNOWN`.
- **Positive example**: `POST /upload` HTTP 200 + OSS `PutObject` success gives presigned link and refreshes `GET /files`.
- **Negative example**: missing `OSS_BUCKET_NAME` results in `AiCoreException(source=OSS, reason=MISSING_CREDENTIALS)` and the upload request is rejected locally.

## Markdown Export APIs
- **Interface**: `ExportManager.exportMarkdown(markdown: String, format: ExportFormat)` with `ExportFormat.PDF` (via `MarkdownPdfEncoder`) and `ExportFormat.CSV` (`MarkdownCsvEncoder`).
- **Output DTO**: `ExportResult { fileName, mimeType, payload(ByteArray), localPath? }`. Payload is consumed by Android sharesheet or storage.
- **Errors**: surfaced as `AiCoreException(source=EXPORT, reason=IO|UNKNOWN)` when PDF/CSV encoders fail or disk IO errors occur.
- **Positive example**: user taps “Export PDF”, method returns `ExportResult(fileName="chat-2025-11-20.pdf", mimeType="application/pdf")`.
- **Negative example**: device storage is full, encoder throws `IOException` → wrapped as `AiCoreException(reason=IO)` and UI prompts user to free space.
